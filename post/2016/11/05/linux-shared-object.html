<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1,minimum-scale=1,maximum-scale=1"><link rel="shortcut icon" href="/favicon.png"><link rel="apple-itouch-icon" href="/favicon.png"><style>img{max-width:100%}</style><script type="text/javascript">function onVisibilityChange(){document.hidden?(document.title="(/≧▽≦/)不要离开我！",clearTimeout(titleTime)):(document.title="True Me | Zetao's Blog",titleTime=setTimeout(function(){document.title=OriginTitile},2e3))}var OriginTitile=document.title,titleTime;document.addEventListener("visibilitychange",onVisibilityChange)</script><script type="text/javascript">"serviceWorker"in navigator&&navigator.serviceWorker.register("/serviceworker.js").then(function(e){console.log("[Service Worker] Registered，rage is",e.scope)})["catch"](function(e){console.log("[Service Worker] Register failed:",e)})</script><style type="text/css">.box{display:none;position:fixed;right:10px;bottom:34px;height:30px;width:50px;text-align:center;padding-top:20px;background-color:#e5e5e5;opacity:.58;border-radius:25px;overflow:hidden;cursor:pointer;z-index:10}.box:hover{background-color:#7f7f7f}.box-in{visibility:visible;display:inline-block;height:20px;width:20px;border:3px solid #000;border-color:#fff transparent transparent #fff;transform:rotate(45deg)}</style><link rel="stylesheet" href="/bundle/index.css"><script type="text/javascript">var timeSinceLang={year:"年前",month:"个月前",day:"天前",hour:"小时前",minute:"分钟前",second:"秒前"},root=""</script><link rel="stylesheet" href="/bundle/iDisqus.min.css"><script src="/bundle/iDisqus.min.js"></script><meta name="keywords" content="libraries,cmake,linux,"><meta name="description" content="Linux 下用 Clion 编写及调用共享库的实践"><title>Linux 下用 Clion 编写及调用共享库的实践</title></head><body style="background-color:#fff" onload="checkDarker()"><article class="container"><header class="header-wrap"><nav><a class="index" href="/"><img class="logo" src="/images/avatar.png"> True Me</a><div onclick="darker()" style="background-image:url(/images/dark-brush.svg);background-size:contain;height:32px;width:32px;margin:1em 0;cursor:pointer"></div></nav><ul class="menu"><li class="menu-item"><a href="/archive.html">归档</a></li><li class="menu-item"><a href="/tag.html">标签</a></li><li class="menu-item"><a href="/blogroll.html">友链</a></li><li class="menu-item"><a href="/about.me.html">关于</a></li><li class="menu-item"><a href="/atom.xml"></a></li></ul><script type="text/javascript">console.log("\n %c Zetao 的小站  %c https://github.com/ZetaoYang/zetaoyang.github.io \n\n","color: #fff; background-image: linear-gradient(90deg, #28C76F 0%, #2DBE60 100%); padding:5px 1px;","background-image: linear-gradient(90deg, #2DBE60 0%, #FFFFFF 100%); padding:5px 0;")</script></header><script type="text/javascript">function checkDarker(){if("rgb(255, 255, 255)"==sessionStorage.getItem("bg")){for(var e=document.getElementsByTagName("p"),t=0;t<e.length;t++)e[t].style.color="#293846";for(var o=document.getElementsByClassName("name"),t=0;t<o.length;t++)o[t].style.color="#293846";for(var s=document.getElementsByTagName("li"),t=0;t<s.length;t++)s[t].style.color="#293846";for(var l=document.getElementsByTagName("h1"),t=0;t<l.length;t++)l[t].style.color="#293846";for(var g=document.getElementsByTagName("h3"),t=0;t<g.length;t++)g[t].style.color="#293846";for(var n=document.getElementsByClassName("link"),t=0;t<n.length;t++)n[t].style.color="#293846"}else if("rgb(63, 63, 63)"===sessionStorage.getItem("bg")){for(var r=document.getElementsByTagName("p"),t=0;t<r.length;t++)r[t].style.color="#c8c8c8";for(var m=document.getElementsByClassName("name"),t=0;t<m.length;t++)m[t].style.color="#c8c8c8";for(var a=document.getElementsByTagName("li"),t=0;t<a.length;t++)a[t].style.color="#c8c8c8";for(var c=document.getElementsByTagName("h1"),t=0;t<c.length;t++)c[t].style.color="#c8c8c8";for(var y=document.getElementsByTagName("h3"),t=0;t<y.length;t++)y[t].style.color="#c8c8c8";for(var d=document.getElementsByClassName("link"),t=0;t<d.length;t++)d[t].style.color="#c8c8c8"}}function darker(){if("rgb(255, 255, 255)"===sessionStorage.getItem("bg")?(sessionStorage.setItem("bg","rgb(63, 63, 63)"),sessionStorage.setItem("md","night")):null==sessionStorage.getItem("bg")?(sessionStorage.setItem("bg","rgb(63, 63, 63)"),sessionStorage.setItem("md","night")):"rgb(63, 63, 63)"===sessionStorage.getItem("bg")&&(sessionStorage.setItem("bg","rgb(255, 255, 255)"),sessionStorage.setItem("md","day")),document.body.style.backgroundColor=sessionStorage.getItem("bg"),document.body.style.color=sessionStorage.getItem("md"),"night"==sessionStorage.getItem("md")){for(var e=document.getElementsByTagName("p"),t=0;t<e.length;t++)e[t].style.color="#c8c8c8";for(var o=document.getElementsByClassName("name"),t=0;t<o.length;t++)o[t].style.color="#c8c8c8";for(var s=document.getElementsByTagName("li"),t=0;t<s.length;t++)s[t].style.color="#c8c8c8";for(var l=document.getElementsByTagName("h1"),t=0;t<l.length;t++)l[t].style.color="#c8c8c8";for(var g=document.getElementsByTagName("h3"),t=0;t<g.length;t++)g[t].style.color="#c8c8c8";for(var n=document.getElementsByClassName("link"),t=0;t<n.length;t++)n[t].style.color="#c8c8c8"}else if("day"==sessionStorage.getItem("md")){for(var r=document.getElementsByTagName("p"),t=0;t<r.length;t++)r[t].style.color="#293846";for(var m=document.getElementsByClassName("name"),t=0;t<m.length;t++)m[t].style.color="#293846";for(var a=document.getElementsByTagName("li"),t=0;t<a.length;t++)a[t].style.color="#293846";for(var c=document.getElementsByTagName("h1"),t=0;t<c.length;t++)c[t].style.color="#293846";for(var y=document.getElementsByTagName("h3"),t=0;t<y.length;t++)y[t].style.color="#293846";for(var d=document.getElementsByClassName("link"),t=0;t<d.length;t++)d[t].style.color="#293846"}}document.body.style.backgroundColor=sessionStorage.getItem("bg"),document.body.style.color=sessionStorage.getItem("md")</script><article class="main article"><h1 class="title">Linux 下用 Clion 编写及调用共享库的实践</h1><section class="info"><span class="avatar" style="background-image:url(/images/avatar.png)"></span> <a class="name" href="/about.me.html">Zetao Yang</a> <span class="date" data-time="1479457353"><span class="from"></span> 更新</span> <span class="tags"><a class="tag" href="/tag/libraries/index.html">libraries</a><a class="tag" href="/tag/cmake/index.html">cmake</a><a class="tag" href="/tag/linux/index.html">linux</a></span></section><article class="content"><p>尝试了一下，Windows 下 Codeblocks 利用 Mingw 编译器编写动态链接库，结果虽然 dll 是生成了，但过程还是不太满意。因为 dll 是 Windows 下才用到的，似乎用 GNU 的编译器不太合适，最终还是改用 VS2015 (虽然它很‘臃肿’)。然后，我就尝试在 Linux 上编写<code>.so</code>(shared object, 共享库。和 dll 类似)文件。<br>在 Linux 上，我尝试了 JetBrains 家的 Clion ，它的代码提示，确实比 Codeblock 好，这点值得肯定。而且在 Linux 上的构建速度比在 Windows 上快(相同硬件条件下) 。虽然 Clion 是收费软件，但是有学生优惠。我用 edu 邮箱申请一年期的免费使用权，到期之后还可以用 edu 邮箱再次验证使用。在能力范围之内，能不用破解软件，就不用破解软件。要<strong>尊重同行的劳动</strong>。</p><p>回到正题，静态库、动态库在不同系统下的对应关系：<br>linux： <code>.a</code> (Archive libraries) 和 <code>.so</code>(Shared object) ;<br>Windows： <code>.lib</code> 和 <code>.dll</code>(Dynamic-link library)</p><h3>先编写一个库试试</h3><p>首先用 Clion 新建一个项目 &ldquo;hello&rdquo;，main.cpp 的内容为：</p><pre><code class="language-c++">#include &lt;iostream&gt;
using namespace std;

void hi()
{
    cout &lt;&lt; &quot;Hello,nihao&quot; &lt;&lt; endl;
}
int add(int a,int b)
{
    return a + b;
}
</code></pre><p>CMakeLists.txt (学名：组态档)的内容：</p><pre><code>cmake_minimum_required(VERSION 3.6)
project(hello)

set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;)

set(SOURCE_FILES main.cpp)
#动态库
add_library(hello SHARED ${SOURCE_FILES})
#静态库
add_library(hell ${SOURCE_FILES})
</code></pre><p>编译生成<code>libhello.so</code>。 可用<code>nm -C libhello.so</code>来查看符号表：</p><pre><code>0000000000201040 B __bss_start
0000000000201040 b completed.7585
                 U __cxa_atexit@@GLIBC_2.2.5
                 w __cxa_finalize@@GLIBC_2.2.5
0000000000000840 t deregister_tm_clones
00000000000008d0 t __do_global_dtors_aux
0000000000200dd0 t __do_global_dtors_aux_fini_array_entry
0000000000201038 d __dso_handle
0000000000200de0 d _DYNAMIC
0000000000201040 D _edata
0000000000201048 B _end
00000000000009e4 T _fini
0000000000000910 t frame_dummy
0000000000200dc0 t __frame_dummy_init_array_entry
0000000000000af0 r __FRAME_END__
0000000000201000 d _GLOBAL_OFFSET_TABLE_
00000000000009cf t _GLOBAL__sub_I_main.cpp
                 w __gmon_start__
00000000000009fc r __GNU_EH_FRAME_HDR
00000000000007b8 T _init
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
0000000000200dd8 d __JCR_END__
0000000000200dd8 d __JCR_LIST__
                 w _Jv_RegisterClasses
0000000000000880 t register_tm_clones
0000000000201040 d __TMC_END__
0000000000000940 T hi()
0000000000000972 T add(int, int)
0000000000000986 t __static_initialization_and_destruction_0(int, int)
                 U std::ostream::operator&lt;&lt;(std::ostream&amp; (*)(std::ostream&amp;))@@GLIBCXX_3.4
                 U std::ios_base::Init::Init()@@GLIBCXX_3.4
                 U std::ios_base::Init::~Init()@@GLIBCXX_3.4
                 U std::cout@@GLIBCXX_3.4
                 U std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp; std::endl&lt;char, std::char_traits&lt;char&gt; &gt;(std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp;)@@GLIBCXX_3.4
00000000000009ed r std::piecewise_construct
0000000000201041 b std::__ioinit
                 U std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp; std::operator&lt;&lt; &lt;std::char_traits&lt;char&gt; &gt;(std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp;, char const*)@@GLIBCXX_3.4
</code></pre><h3>动态库显式调用(运行时装入)</h3><p>新建一个项目 &ldquo;openso&rdquo;，以下是<code>main.cpp</code>的内容：</p><pre><code class="language-c++">#include &lt;iostream&gt;
#include &quot;dlfcn.h&quot;//显式调用的头文件

using namespace std;

int main() {

    cout &lt;&lt; &quot;C++ dlopen&quot; &lt;&lt; endl;

    // 打开库文件
    cout &lt;&lt; &quot;Opening libhello.so...&quot; &lt;&lt; endl;
    //动态库 libhello.so 的绝对路径
    void *handle = dlopen(&quot;/home/yang/Desktop/openso/lib/libhello.so&quot;, RTLD_LAZY);

    if (!handle) {
        cerr &lt;&lt; &quot;Cannot open library: &quot; &lt;&lt; dlerror() &lt;&lt; endl;
        return 1;
    }

    // 加载符号表
    cout &lt;&lt; &quot;Loading symbol hi...&quot; &lt;&lt; endl;
    typedef void (*hi_t)();

    // 错误
    dlerror();
    hi_t hi = (hi_t) dlsym(handle, &quot;hi&quot;);
    const char *dlsym_error = dlerror();
    if (dlsym_error) {
        cerr &lt;&lt; &quot;Cannot load symbol 'hi': &quot; &lt;&lt; dlsym_error &lt;&lt; endl;
        dlclose(handle);
        return 1;
    }

    cout &lt;&lt; &quot;Calling hi()...&quot; &lt;&lt; endl;
    hi();

    // 加载符号表
    cout &lt;&lt; &quot;Loading symbol add...&quot; &lt;&lt; endl;
    typedef int (*add_t)(int, int);

    // 错误
    dlerror();
    add_t add = (add_t) dlsym(handle, &quot;add&quot;);
    if (dlsym_error) {
        cerr &lt;&lt; &quot;Cannot load symbol 'add': &quot; &lt;&lt; dlsym_error &lt;&lt; endl;

        dlclose(handle);
        return 1;
    }

    cout &lt;&lt; &quot;Calling the add()...&quot;&lt;&lt; endl;
    cout &lt;&lt; add(2, 3) &lt;&lt; &quot; is the result&quot;&lt;&lt; endl;

    // 关闭库文件
    cout &lt;&lt; &quot;Closing library...&quot;&lt;&lt; endl;
    dlclose(handle);
}
</code></pre><p>CMakeLists.txt 的内容：</p><pre><code>cmake_minimum_required(VERSION 3.6)
project(openso)

set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;)
set(SOURCE_FILES main.cpp)
add_executable(openso ${SOURCE_FILES})
target_link_libraries(openso ${CMAKE_DL_LIBS})
</code></pre><p>编译，也可以在项目的根目录下执行<code>g++ -o main main.cpp -ldl</code>。</p><p>程序运行结果如下：</p><pre><code>C++ dlopen
Opening libhello.so...
Loading symbol hi...
Calling hi()...
Hello,nihao
Loading symbol add...
Calling the add()...
5 is the result
Closing library...
</code></pre><h3>动态库隐式调用(编译时装入)</h3><p>新建一个项目 &ldquo;hideso&rdquo;，以下是<code>main.cpp</code>的内容：</p><pre><code class="language-c++">#include &lt;iostream&gt;
using namespace std;

void hi();
int  add(int,int);

int main(int argc,char *argv[])
{
    hi();
    cout &lt;&lt; endl;
    cout &lt;&lt; add(13,12) &lt;&lt; endl;
    return 0;
}  
</code></pre><p>CMakeLists.txt 的内容：</p><pre><code>cmake_minimum_required(VERSION 3.6)
project(hideso)

set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;)

set(SOURCE_FILES main.cpp)
add_executable(hideso ${SOURCE_FILES})
target_link_libraries(hideso /home/yang/Desktop/hideso/libhello.so)
</code></pre><p>编译，也可以在项目的根目录下执行<code>g++ -o main main.cpp ./libhello.so</code>。</p><p>在执行隐式链接的程序之前，需要设置 LD_LIBRARY_PATH 环境变量，或者把前面生成的 libhello.so 复制到系统路径下，否则报错：</p><pre><code>error while loading shared libraries: libhello.so: cannot open shared object file: No such file or directory
</code></pre><p>运行可在项目根目录下执行：</p><pre><code>export LD_LIBRARY_PATH=.
./main
</code></pre><p>还可直接用<code>ldd</code>命令查看其所隐式调用的库。</p><p>对于 C 语言编译的库，C++ 调用时需要这么做(保证C/C++ 兼容性，注意<code>cplusplus</code>前面是两个&rsquo;_&lsquo;)：</p><pre><code class="language-c++">#include &lt;iostream&gt;
using namespace std;

#ifdef __cplusplus
extern &quot;C&quot;
{
#endif
	void hi();
	int add(int,int);
#ifdef __cplusplus
}
#endif

int main(int argc,char *argv[])
{
    hi();
    cout &lt;&lt; endl;
    cout &lt;&lt; add(12,13) &lt;&lt; endl;
    return 0;
}
</code></pre><p>当然了，C++ 编写的库，C 是无法直接调用的。那如果 C 想调用 C++的库， 应该怎么做呢？请接着往下看。</p><h3>C 调用 C++ 库</h3><p>C 调用 C++ 的库，一般不能直接调用，需要将 C++ 库转换成 C 接口(也就是要用<code>extern &quot;C&quot;</code>)输出，才可以用 C 来调用，这里举个例子(比如 C++ 中的“类”)：</p><pre><code class="language-c++">#include &lt;iostream&gt;

#ifdef __cplusplus
extern &quot;C&quot;
{
#endif
    int here();
#ifdef __cplusplus
}
#endif

using namespace std;

class Hi {
    public:
    int hello() {
        cout &lt;&lt; &quot;here() is called&quot; &lt;&lt; endl;
    }
};

int here() {
    Hi hh;
    hh.hello();
    return 0;
}

</code></pre><p>CMakeLists.txt 内容不再赘述。</p><p>接下来只简单说一下它的显示调用：</p><pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;dlfcn.h&gt;

int main()
{
    int (*dlfunc)();
    void *handle;  //定义一个句柄
    handle = dlopen(&quot;./libcppso.so&quot;, RTLD_LAZY);//获得库句柄
    dlfunc = dlsym(handle, &quot;here&quot;); //获得函数入口
    (*dlfunc)();
    dlclose(handle); 

    return 0;
}
</code></pre><p>运行输出如下：</p><pre><code>here() is called
</code></pre><h3>CMake 相关:</h3><blockquote><p><a href="https://cmake.org/Wiki/CMake">CMake Wiki</a><br><a href="http://elloop.github.io/tools/2016-04-10/learning-cmake-2-commands">CMake 常用命令和变量</a><br><a href="http://linghutf.github.io/2016/06/16/cmake/">CMake使用进阶</a><br><a href="http://reyoung.me/post/cmake_talk_1/">CMake 简要教程&ndash;相关工具对比</a></p></blockquote><h3>Make 相关</h3><p>Makefile + make 为 Unix-like 环境下的项目管理工具(抽象程度低)。对于如何使用 Makefile 编译动态库和静态库，可参考这篇文章：<a href="http://blog.csdn.net/shaoxiaohu1/article/details/46943417">linux编译动态库和静态库的makefile示例</a> 。需要说明一点：<strong>cmake 也是根据 CMakeLists.txt 文件去生成 Makefile 的</strong> (可以跨平台生成对应平台能用的 Makefile) 。而且 cmake 是抽象层次更高的项目管理工具。当你需要编译一个大项目，而大项目各文件的依赖关系复杂，Makefile 并不好写，这时使用 cmake 则很方便。</p><h3>链接、装载与库相关</h3><p>可以看看《程序员的自我修养——链接、装载与库》这本书。</p></article><section class="author"><div class="avatar" style="background-image:url(/images/avatar.png)"></div><a class="name" href="/about.me.html">Zetao Yang</a><div class="intro">Thoughts and ideas.</div></section><section class="recommend"><section class="nav prev more"><div class="head">上篇文章</div><a class="link" href="/./post/2016/11/13/caddy-server.html">Debian 上搭建 Caddy Server</a></section><section class="nav next more"><div class="head">下篇文章</div><a class="link" href="/./post/2016/11/01/rime.html">谈谈 RIME</a></section></section><style type="text/css">.comment-toggle{display:-webkit-box;display:-ms-flexbox;display:flex;font-size:14px}.comment-toggle .comment-toggle-input{display:none}.comment-toggle .comment-toggle-input:checked+.comment-toggle-icon{background-color:#2aa0ff}.comment-toggle .comment-toggle-input:checked+.comment-toggle-icon:before{margin-left:11px}.comment-toggle .comment-toggle-input:disabled~.comment-toggle-button,.comment-toggle .comment-toggle-input:disabled~.comment-toggle-icon{display:none}.comment-toggle .comment-toggle-icon{display:block;width:26px;height:15px;background-color:#434343;border-radius:10px;cursor:pointer;padding:2.5px 3px;-webkit-transition:all .3s;transition:all .3s}.comment-toggle .comment-toggle-icon:before{-webkit-transition:all .3s;transition:all .3s;content:"";display:block;width:15px;height:15px;border-radius:50%;background-color:#fff}.comment-toggle .comment-toggle-button{display:block;color:#fff!important;background-color:#434343;border-radius:2px;line-height:20px;height:20px;padding:0 3px;cursor:pointer;margin:0 5px}</style><section style="display:block;margin-top:40px"><div class="comment-toggle"><input type="checkbox" id="comment-toggle" class="comment-toggle-input" disabled="disabled"><label class="comment-toggle-icon" for="comment-toggle"></label><label class="comment-toggle-button" for="comment-toggle">评论框</label></div></section><div id="comment"></div><script>var disq=new iDisqus("comment",{forum:"zetao",api:"https://d.sogaso.ga/disqus",site:"https://zty.js.org",mode:3,timeout:3e3,init:!0,toggle:"comment-toggle",sort:"newest",emoji_preview:!0,badge:"博主"});disq.popular(),disq.count()</script></article></article><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85037972-1","auto"),ga("send","pageview")</script><footer class="footer"><span class="copyright">True Me ©2016-<script type="text/javascript">document.write((new Date).getFullYear())</script>&nbsp;Zetao 的小站 </span><span class="publish">本站使用<a href="https://creativecommons.org/licenses/by/4.0/deed.zh">「署名 4.0 国际」</a>创作共享协议</span></footer><div id="to-top" class="box"><div class="box-in"><div><div><script>window.onscroll=function(){var o=document.documentElement.scrollTop||document.body.scrollTop,e=document.documentElement.clientHeight||document.body.clientHeight;a.style.display=o>e?"block":"none"};var a=document.getElementById("to-top");a.onclick=function(){var o=500,e=10,n=document.documentElement.scrollTop||document.body.scrollTop,t=n/o*e,c=window.setInterval(function(){var o=document.documentElement.scrollTop||document.body.scrollTop;0==o&&window.clearInterval(c),document.documentElement.scrollTop=o-t,document.body.scrollTop=o-t},e);return!1}</script><script src="/bundle/index.js"></script></div></div></div></div></body></html>