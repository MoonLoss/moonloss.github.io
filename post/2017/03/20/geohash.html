<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1,minimum-scale=1,maximum-scale=1"><link rel="shortcut icon" href="/favicon.png"><link rel="apple-itouch-icon" href="/favicon.png"><style>img{max-width:100%}</style><script type="text/javascript">function onVisibilityChange(){document.hidden?(document.title="(/≧▽≦/)不要离开我！",clearTimeout(titleTime)):(document.title="True Me | Zetao's Blog",titleTime=setTimeout(function(){document.title=OriginTitile},2e3))}var OriginTitile=document.title,titleTime;document.addEventListener("visibilitychange",onVisibilityChange)</script><script type="text/javascript">"serviceWorker"in navigator&&navigator.serviceWorker.register("/serviceworker.js").then(function(e){console.log("[Service Worker] Registered，rage is",e.scope)})["catch"](function(e){console.log("[Service Worker] Register failed:",e)})</script><style type="text/css">.box{display:none;position:fixed;right:10px;bottom:34px;height:30px;width:50px;text-align:center;padding-top:20px;background-color:#e5e5e5;opacity:.58;border-radius:25px;overflow:hidden;cursor:pointer;z-index:10}.box:hover{background-color:#7f7f7f}.box-in{visibility:visible;display:inline-block;height:20px;width:20px;border:3px solid #000;border-color:#fff transparent transparent #fff;transform:rotate(45deg)}</style><link rel="stylesheet" href="/bundle/index.css"><script type="text/javascript">var timeSinceLang={year:"年前",month:"个月前",day:"天前",hour:"小时前",minute:"分钟前",second:"秒前"},root=""</script><link rel="stylesheet" href="/bundle/iDisqus.min.css"><script src="/bundle/iDisqus.min.js"></script><meta name="keywords" content="geohash,algorithm,"><meta name="description" content="Geohash 编码解码 C 语言实现"><title>Geohash 编码解码 C 语言实现</title></head><body style="background-color:#fff" onload="checkDarker()"><article class="container"><header class="header-wrap"><nav><a class="index" href="/"><img class="logo" src="/images/avatar.png"> True Me</a><div onclick="darker()" style="background-image:url(/images/dark-brush.svg);background-size:contain;height:32px;width:32px;margin:1em 0;cursor:pointer"></div></nav><ul class="menu"><li class="menu-item"><a href="/archive.html">归档</a></li><li class="menu-item"><a href="/tag.html">标签</a></li><li class="menu-item"><a href="/blogroll.html">友链</a></li><li class="menu-item"><a href="/about.me.html">关于</a></li><li class="menu-item"><a href="/atom.xml"></a></li></ul><script type="text/javascript">console.log("\n %c Zetao 的小站  %c https://github.com/ZetaoYang/zetaoyang.github.io \n\n","color: #fff; background-image: linear-gradient(90deg, #28C76F 0%, #2DBE60 100%); padding:5px 1px;","background-image: linear-gradient(90deg, #2DBE60 0%, #FFFFFF 100%); padding:5px 0;")</script></header><script type="text/javascript">function checkDarker(){if("rgb(255, 255, 255)"==sessionStorage.getItem("bg")){for(var e=document.getElementsByTagName("p"),t=0;t<e.length;t++)e[t].style.color="#293846";for(var o=document.getElementsByClassName("name"),t=0;t<o.length;t++)o[t].style.color="#293846";for(var s=document.getElementsByTagName("li"),t=0;t<s.length;t++)s[t].style.color="#293846";for(var l=document.getElementsByTagName("h1"),t=0;t<l.length;t++)l[t].style.color="#293846";for(var g=document.getElementsByTagName("h3"),t=0;t<g.length;t++)g[t].style.color="#293846";for(var n=document.getElementsByClassName("link"),t=0;t<n.length;t++)n[t].style.color="#293846"}else if("rgb(63, 63, 63)"===sessionStorage.getItem("bg")){for(var r=document.getElementsByTagName("p"),t=0;t<r.length;t++)r[t].style.color="#c8c8c8";for(var m=document.getElementsByClassName("name"),t=0;t<m.length;t++)m[t].style.color="#c8c8c8";for(var a=document.getElementsByTagName("li"),t=0;t<a.length;t++)a[t].style.color="#c8c8c8";for(var c=document.getElementsByTagName("h1"),t=0;t<c.length;t++)c[t].style.color="#c8c8c8";for(var y=document.getElementsByTagName("h3"),t=0;t<y.length;t++)y[t].style.color="#c8c8c8";for(var d=document.getElementsByClassName("link"),t=0;t<d.length;t++)d[t].style.color="#c8c8c8"}}function darker(){if("rgb(255, 255, 255)"===sessionStorage.getItem("bg")?(sessionStorage.setItem("bg","rgb(63, 63, 63)"),sessionStorage.setItem("md","night")):null==sessionStorage.getItem("bg")?(sessionStorage.setItem("bg","rgb(63, 63, 63)"),sessionStorage.setItem("md","night")):"rgb(63, 63, 63)"===sessionStorage.getItem("bg")&&(sessionStorage.setItem("bg","rgb(255, 255, 255)"),sessionStorage.setItem("md","day")),document.body.style.backgroundColor=sessionStorage.getItem("bg"),document.body.style.color=sessionStorage.getItem("md"),"night"==sessionStorage.getItem("md")){for(var e=document.getElementsByTagName("p"),t=0;t<e.length;t++)e[t].style.color="#c8c8c8";for(var o=document.getElementsByClassName("name"),t=0;t<o.length;t++)o[t].style.color="#c8c8c8";for(var s=document.getElementsByTagName("li"),t=0;t<s.length;t++)s[t].style.color="#c8c8c8";for(var l=document.getElementsByTagName("h1"),t=0;t<l.length;t++)l[t].style.color="#c8c8c8";for(var g=document.getElementsByTagName("h3"),t=0;t<g.length;t++)g[t].style.color="#c8c8c8";for(var n=document.getElementsByClassName("link"),t=0;t<n.length;t++)n[t].style.color="#c8c8c8"}else if("day"==sessionStorage.getItem("md")){for(var r=document.getElementsByTagName("p"),t=0;t<r.length;t++)r[t].style.color="#293846";for(var m=document.getElementsByClassName("name"),t=0;t<m.length;t++)m[t].style.color="#293846";for(var a=document.getElementsByTagName("li"),t=0;t<a.length;t++)a[t].style.color="#293846";for(var c=document.getElementsByTagName("h1"),t=0;t<c.length;t++)c[t].style.color="#293846";for(var y=document.getElementsByTagName("h3"),t=0;t<y.length;t++)y[t].style.color="#293846";for(var d=document.getElementsByClassName("link"),t=0;t<d.length;t++)d[t].style.color="#293846"}}document.body.style.backgroundColor=sessionStorage.getItem("bg"),document.body.style.color=sessionStorage.getItem("md")</script><article class="main article"><h1 class="title">Geohash 编码解码 C 语言实现</h1><section class="info"><span class="avatar" style="background-image:url(/images/avatar.png)"></span> <a class="name" href="/about.me.html">Zetao Yang</a> <span class="date" data-time="1489979022"><span class="from"></span> 更新</span> <span class="tags"><a class="tag" href="/tag/geohash/index.html">geohash</a><a class="tag" href="/tag/algorithm/index.html">algorithm</a></span></section><article class="content"><h3>什么是 Geohash</h3><p>Geohash，是由 Gustavo Niemeyer 提出对地图坐标进行编码的一种方式。其思想策略是分治，将地理坐标值转化为二进制码。</p><p>例如：坐标北京海淀区附近 L(116.308785,39.980778)，先对经度进行编码：</p><p>首先，将区间 (-180.0,180.0) 分为 (-180.0,0.0)，(0.0,180.0)，如果经度属于前者，则二进制码为 0，否则为 1。因为 116.308785 属于 (0.0,180.0)，所以第一位为 1。</p><p>然后对 (0.0,180.0) 再进行一次二分，分为 (0.0,90.0),(90.0,180.0)，该经度属于后者，因此第二位仍然为 1。</p><p>第三次对 (90.0,180.0) 二分，第四次对 (90.0,135.0) 二分，这样经过多次分割之后(二分次数取决于经纬度的精度，这里经度的精度是 6 位小数)，就可以得到一个表示经度的二进制串：</p><pre><code>1101001010110101010111100
</code></pre><p>同样地，对纬度 39.980778 也进行编码，可以得到表示纬度的二进制串：</p><pre><code>1011100011011100100011101
</code></pre><p>最后一步，需要将两个经纬度编码进行合并，两个串「剪开」再「拼接」为一个二进制编码。</p><p>依次取经度和纬度的每一位进行合并(奇数位为经度，偶数位为纬度)：</p><pre><code>lon: 1 1 0 1 0 0 1 0 1 0 1 1 0 1 0 1 0 1 0 1 1 1 1 0 0

     11100111010010001101101101110010011000101111110001
     
lat: 1 0 1 1 1 0 0 0 1 1 0 1 1 1 0 0 1 0 0 0 1 1 1 0 1
</code></pre><p>得到合并的二进制码后，需要将其每 5 位分为一组，并使用 base32 将其转化为对应的字符。介绍就这么多，如果还想详细地了解 Geohash ，就看本文最后的参考资料吧。</p><h3>base32 编解码</h3><p>大家一定很好奇，为什么这里要提 base32 呢？因为我是用 C 实现嘛！(得自己造轮子) <code>base32.c</code>文件：</p><pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &quot;../include/base32.h&quot;

//base32 表包含 0~9 以及小写字母 (去除'a','i','l','o')，
//共 32 个字符
static const char base32_alphabet[32] = {
        '0', '1', '2', '3', '4', '5', '6', '7',
        '8', '9', 'b', 'c', 'd', 'e', 'f', 'g',
        'h', 'j', 'k', 'm', 'n', 'p', 'q', 'r',
        's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
};

/**
 * 匹配 base32_alphabet
 * @param m char
 * @return i int
 */
int find_number(char m) {
    int i;
    for(i = 0; i &lt; 32; ++i)
    {
        if(m == base32_alphabet[i])
            return i;
    }
    return -1;
}

/**
 * base32 编码
 * @param bin_source char*
 * @return str char*
 */

char* base32_encode(char *bin_source){
    int i;
    int j = 0;
    static char str[10];

    for(i=0;i&lt;strlen(bin_source);++i){
        if((i+1)%5==0){
            j++;
            int num = (bin_source[i]-'0')+(bin_source[i-1]-'0')*2\
            +(bin_source[i-2]-'0')*2*2+(bin_source[i-3]-'0')*2*2*2\
            +(bin_source[i-4]-'0')*2*2*2*2;

            str[j-1] = base32_alphabet[num];
        }

    }
    return str;
}

/**
 * base32 解码
 * @param str_source char*
 * @return dec int*
 */
int* base32_decode(char *str_source){
    int i,j;
    static int dec[50];
    int count=0;
    for(i=0;i&lt;strlen(str_source);++i){
        for(j=5-1;j&gt;=0;--j){
            count++;
            //位运算十进制转二进制
            dec[count-1] = find_number(str_source[i])&gt;&gt;(j%5)&amp;1;
        }
    }
    return dec;
}
</code></pre><h3>Geohash 实现</h3><pre><code class="language-C">#include &lt;stdio.h&gt;
#include &quot;include/base32.h&quot;

/**
 * 经纬度 二进制混合编码
 * @param lon double
 * @param lat double
 * @return char*
 */
char* encode(double lon, double lat){
    double latM,lonM;
    char lon_ans[25];
    char lat_ans[25];
    static char ans[50];
    double lonL = -180.0, lonR = 180.0;
    double latL = -90.0, latR = 90.0;
    int i,j;
    for(i=0;i&lt;25;++i){
        latM = (latL + latR) / 2.0;
        lonM = (lonL + lonR) / 2.0;
        if(lon - lonM &gt;= 0) lon_ans[i] = '1', lonL = lonM;
        else    lon_ans[i] = '0', lonR = lonM;
        if(lat - latM &gt;= 0) lat_ans[i] = '1', latL = latM;
        else    lat_ans[i] = '0', latR = latM;
    }

    //将两个经纬度进行合并，组合为一个二进制编码
    for(j=0;j&lt;50;++j) {
        if((j+1)%2==1) ans[j] = lon_ans[(j+1)/2];
        else ans[j] = lat_ans[j/2];
    }

    return ans;
}

/**
 * 将二进制解码为经纬度
 * @param bin_num int*
 * @return double*
 */
double* decode(int *bin_num){
    int i;
    double latM,lonM;
    static double result[2];
    double lonL = -180.0, lonR = 180.0;
    double latL = -90.0, latR = 90.0;
    int lon_ans[25];
    int lat_ans[25];
    for(i=0;i&lt;50;++i){
        if((i+1)%2==1){
            lon_ans[(i+1)/2] = bin_num[i];
        }else{
            lat_ans[(i/2)] = bin_num[i];
        }
    }

    for(i=0;i&lt;25;++i){
        if(lon_ans[i]==1){
            lonL = lonM;
            lonM = (lonL+lonR)/2.0;
        }else if(lon_ans[i]==0){
            lonR = lonM;
            lonM = (lonL+lonR)/2.0;
        }

        if(lat_ans[i]==1){
            latL = latM;
            latM = (latL+latR)/2.0;
        }else if(lat_ans[i]==0){
            latR = latM;
            latM = (latL+latR)/2.0;
        }

    }
    result[0] = latM;
    result[1] = lonM;
    return result;
}

int main(){
    int n,m;
    double x,y;
    double *lon_lat_res;
    char *bin_str;
    char *str;
    char des_str[10];
    int *bin_num;
    int i,j;
    scanf(&quot;%d %d&quot;,&amp;n,&amp;m);

//输入经纬度，输出 geohash 编码
    for(i=0;i&lt;n;++i){
        scanf(&quot;%lf %lf&quot;,&amp;x,&amp;y);
        bin_str = encode(x,y);
        str = base32_encode(bin_str);
        for(j=0;j&lt;10;++j){
            printf(&quot;%c&quot;,*(str+j));
        }
        printf(&quot;\n&quot;);
    }

//输入 geohash 编码，输出 经纬度
    for(i=0;i&lt;m;++i){
        scanf(&quot;%s&quot;,des_str);
        bin_num = base32_decode(des_str);
        lon_lat_res = decode(bin_num);
        //前面是经度，后面是纬度
        printf(&quot;%lf %lf\n&quot;,*(lon_lat_res+1),*lon_lat_res);
    }

    return 0;
}
</code></pre><p>输入：</p><p>第 1 行：2 个整数 n,m。1≤n,m≤100。<br>第 2..n+1 行：每行 2 个实数 x,y，第 i+1 行表示第 i 个点的纬度和经度。-90≤x≤90，-180≤y≤180<br>第 n+2..n+m+1 行：每行 1 个字符串，表示需要解码的 Geohash 串。</p><p>输出：</p><p>第 1..n 行：每行 1 个字符串，第 i 行表示以第 i 个点的 Geohash 编码，长度为 10。<br>第 n+1..n+m 行：每行 2 个实数 x,y。<br>第 n+i 行表示以第 i 个 geohash 编码所表示的区域中心点坐标，保留 6 位小数。</p><p>运行结果：</p><pre><code>&gt;&gt;&gt; ./geohash.exe
&gt;&gt;&gt; 3 2
&gt;&gt;&gt; 117.103367 36.255833
ww7q2b0jd1
&gt;&gt;&gt; 112.688922 27.293056
wsb5k299d4
&gt;&gt;&gt; 110.082600 34.477861
wqnk0ux8n7 
&gt;&gt;&gt; wx0csn0ng8
113.730624 39.672792 
&gt;&gt;&gt; ww0k7k0et7
112.995302 34.519663
</code></pre><p>完整 Clion 工程<a href="https://github.com/ZetaoYang/Code/tree/hihocoder">在这</a>(包含 .exe 可执行文件)。</p><h3>代码解释</h3><p>我认为算法实现的核心就是「二分」，这部分没什么可讲的。在实现过程中最令我头疼是十进制转二进制(不要告诉我用 itoa()，sprintf()，因为 itoa() 在 Linux 中没有此函数 )，需要将十进制数转为 5 位的二进制数，这里用位运算更方便一些。例如：x 为需要转化的十进制数，</p><pre><code class="language-C">for(i=5-1;i&gt;=0;--i) printf(&quot;%d&quot;,x&gt;&gt;i&amp;1);
</code></pre><p>我们都知道，奇数的二进制最后一位全部为<code>1</code>，而偶数的二进制最后一位全部为<code>0</code>，这样用按位与运算可以很方便地知道一个数是奇数还是偶数，只要让数字<code>&amp;1</code>就可以了，因为<code>奇数 &amp; 1=1</code>，而<code>偶数 &amp; 1=0</code>。<code>x&gt;&gt;i</code>—— x 右移 i 位，相当于被 2 除了 i 遍。</p><p>这段代码被用在 bas32.c 的 base32_decode() 函数。</p><h3>参考资料</h3><ul><li><a href="https://en.wikipedia.org/wiki/Geohash">Geohash,Wikipedia</a></li><li><a href="http://www.cnblogs.com/LBSer/p/3310455.html">GeoHash 核心原理解析</a></li><li><a href="http://evthoriz.com/2015/07/02/Geohash%20%E7%AE%97%E6%B3%95%E7%9A%84%E8%BE%B9%E7%95%8C%E9%97%AE%E9%A2%98/">Geohash 算法的 8 个矩形</a></li><li><a href="http://charlee.li/geohash-intro.html">geohash：用字符串实现附近地点搜索</a></li><li><a href="https://github.com/vinsci/geohash/">Python module Geohash</a></li></ul></article><section class="author"><div class="avatar" style="background-image:url(/images/avatar.png)"></div><a class="name" href="/about.me.html">Zetao Yang</a><div class="intro">Thoughts and ideas.</div></section><section class="recommend"><section class="nav prev more"><div class="head">上篇文章</div><a class="link" href="/./post/2017/04/28/phantomjs.html">初探 PhantomJS &#43; Selenium 模拟浏览器行为</a></section><section class="nav next more"><div class="head">下篇文章</div><a class="link" href="/./post/2017/02/27/add-night-mode-and-service-worker-for-your-blog.html">给你的独立博客加上夜间模式以及 Service Worker</a></section></section><style type="text/css">.comment-toggle{display:-webkit-box;display:-ms-flexbox;display:flex;font-size:14px}.comment-toggle .comment-toggle-input{display:none}.comment-toggle .comment-toggle-input:checked+.comment-toggle-icon{background-color:#2aa0ff}.comment-toggle .comment-toggle-input:checked+.comment-toggle-icon:before{margin-left:11px}.comment-toggle .comment-toggle-input:disabled~.comment-toggle-button,.comment-toggle .comment-toggle-input:disabled~.comment-toggle-icon{display:none}.comment-toggle .comment-toggle-icon{display:block;width:26px;height:15px;background-color:#434343;border-radius:10px;cursor:pointer;padding:2.5px 3px;-webkit-transition:all .3s;transition:all .3s}.comment-toggle .comment-toggle-icon:before{-webkit-transition:all .3s;transition:all .3s;content:"";display:block;width:15px;height:15px;border-radius:50%;background-color:#fff}.comment-toggle .comment-toggle-button{display:block;color:#fff!important;background-color:#434343;border-radius:2px;line-height:20px;height:20px;padding:0 3px;cursor:pointer;margin:0 5px}</style><section style="display:block;margin-top:40px"><div class="comment-toggle"><input type="checkbox" id="comment-toggle" class="comment-toggle-input" disabled="disabled"><label class="comment-toggle-icon" for="comment-toggle"></label><label class="comment-toggle-button" for="comment-toggle">评论框</label></div></section><div id="comment"></div><script>var disq=new iDisqus("comment",{forum:"zetao",api:"https://d.sogaso.ga/disqus",site:"https://zty.js.org",mode:3,timeout:3e3,init:!0,toggle:"comment-toggle",sort:"newest",emoji_preview:!0,badge:"博主"});disq.popular(),disq.count()</script></article></article><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85037972-1","auto"),ga("send","pageview")</script><footer class="footer"><span class="copyright">True Me ©2016-<script type="text/javascript">document.write((new Date).getFullYear())</script>&nbsp;Zetao 的小站 </span><span class="publish">本站使用<a href="https://creativecommons.org/licenses/by/4.0/deed.zh">「署名 4.0 国际」</a>创作共享协议</span></footer><div id="to-top" class="box"><div class="box-in"><div><div><script>window.onscroll=function(){var o=document.documentElement.scrollTop||document.body.scrollTop,e=document.documentElement.clientHeight||document.body.clientHeight;a.style.display=o>e?"block":"none"};var a=document.getElementById("to-top");a.onclick=function(){var o=500,e=10,n=document.documentElement.scrollTop||document.body.scrollTop,t=n/o*e,c=window.setInterval(function(){var o=document.documentElement.scrollTop||document.body.scrollTop;0==o&&window.clearInterval(c),document.documentElement.scrollTop=o-t,document.body.scrollTop=o-t},e);return!1}</script><script src="/bundle/index.js"></script></div></div></div></div></body></html>